<html>
<head>
  <title></title>
  <meta charset="utf-8">

  <style type="text/css">
body {
  font-family: "Droid Serif", serif;
  font-size: 16px;
  line-height: 140%;
  width: 56em;
  margin-left: 5em;
  text-align: justify;
}
h1 {
  padding-top: 1.5em;
  padding-bottom: .3em;
  font-family: "Droid Sans", sans-serif;
  text-align: center;
}
h2 {
  font-family: "Droid Sans", sans-serif;
  text-indent: 1em;
}
a {
  color: black;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}
  </style>

  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/javascript">
var server = require('http').createServer(httpHandler);
var spawn = require('child_process').spawn

function httpHandler(req, res){
  switch(req.method)
  {
  case 'PUT':
    console.log('received PUT');

    var pandoc = spawn('pandoc', 
        [ '-t'
        , 'html5'
        , '--smart'
        , '--bibliography=/home/js947/Documents/papers/default.bib'
        , '--csl=/opt/styles/association-for-computing-machinery.csl'
        , '--mathjax'
        ]);

    var newHTML = '';
    var input_encoded = '';

    req.on('data', function(chunk) {
        input_encoded += chunk;
        });
    req.on('end', function() {
        var input_decoded = new Buffer(input_encoded, 'base64').toString('utf8');
        pandoc.stdin.write(input_decoded);
        pandoc.stdin.end();
        res.writeHead(200);
        res.end();
        });

    pandoc.stdout.on('data', function (data) {
        console.log('pandoc stdout: ' + data);
        newHTML += data;
        });
    pandoc.stderr.on('data', function (data) {
        console.log('pandoc stderr: ' + data);
        });
    pandoc.on('exit', function (code) {
        console.log('pandoc child process exited with code ' + code);
        document.body.innerHTML = newHTML;
        MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
        });
    break;

  case 'DELETE':
    req.on('end', function() {
      res.writeHead(200);
      res.end();
      });
    window.close();

  default:
    break;
  }
}
server.listen(8080);
  </script>
</head>
<body>
  Waiting for connection from client...
</body>
</html>
